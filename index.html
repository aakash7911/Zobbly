<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zobbly - The Zebra Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL & ANIMATED BACKGROUND --- */
        body {
            font-family: 'Inter', sans-serif; margin: 0; padding: 0;
            background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #a18cd1, #fbc2eb, #84fab0, #8fd3f4);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh; color: #1a1a1a;
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .hidden-screen { display: none !important; }

        /* GLASS UI */
        .glass-header-top { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05); }
        /* Updated Glass Nav for Desktop adaptability */
        .glass-nav-bottom { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border-top: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.05); }
        
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); }

        .nav-item { transition: all 0.3s ease; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 20%; height: 100%; }
        .nav-active { color: #a18cd1 !important; transform: translateY(-2px); }
        .nav-active::after { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 40%; height: 3px; background: #a18cd1; border-radius: 0 0 4px 4px; }

        /* Desktop Specific Nav Styles */
        @media (min-width: 768px) {
            .glass-nav-bottom {
                border-top: none;
                border-right: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 4px 0 30px rgba(0, 0, 0, 0.05);
                background: rgba(255, 255, 255, 0.6);
            }
            .nav-item {
                width: 100%;
                flex-direction: row;
                justify-content: flex-start;
                padding-left: 1.5rem;
                height: 3.5rem;
                margin-bottom: 0.5rem;
                border-radius: 12px;
            }
            .nav-item:hover {
                background: rgba(255,255,255,0.5);
            }
            .nav-active { transform: none; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
            .nav-active::after {
                top: 50%; left: 0; transform: translateY(-50%);
                width: 4px; height: 60%;
                border-radius: 0 4px 4px 0;
            }
        }

        /* BUTTONS */
        .btn-zobbly { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3); transition: all 0.3s ease; }
        .btn-zobbly:hover { transform: translateY(-2px); }
        .btn-follow { font-size: 11px; padding: 5px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-left: auto; }
        .btn-not-following { background: black; color: white; border: 1px solid transparent; }
        .btn-following { background: transparent; color: black; border: 1px solid #ccc; }

        @keyframes popOutEffect { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop-view { animation: popOutEffect 0.4s ease-out forwards; }

        /* --- AUTH SCREEN STYLES --- */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: inherit; z-index: 100; }
        .auth-container { position: relative; width: 100%; max-width: 360px; padding: 20px; display: flex; justify-content: center; align-items: center; margin-top: 30px; }
        .doll-main { position: absolute; width: 180px; top: -120px; z-index: 20; animation: breathe 3s ease-in-out infinite; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .char-yellow { position: absolute; width: 85px; top: -45px; right: -10px; z-index: 5; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0); } }
        .char-orange { position: absolute; width: 160px; bottom: -55px; right: -50px; z-index: 10; transform: rotate(-10deg); }

        .login-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); width: 100%; padding: 90px 25px 30px; border-radius: 35px; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1); position: relative; z-index: 5; border: 1px solid rgba(255,255,255,0.5); }
        .icon-lock-img { position: absolute; width: 45px; top: 35px; right: 25px; }
        .auth-h2 { color: #333; font-size: 28px; margin-bottom: 20px; font-weight: 800; text-align: center; }

        .input-group { margin-bottom: 15px; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #90a0b5; font-size: 16px; }
        .input-wrapper input { width: 100%; padding: 15px 15px 15px 50px; background: rgba(255,255,255,0.6); border: 2px solid transparent; border-radius: 50px; font-size: 15px; color: #333; outline: none; transition: 0.3s; }
        .input-wrapper input:focus { background: #fff; border-color: #a18cd1; box-shadow: 0 0 10px rgba(161, 140, 209, 0.3); }
        .input-wrapper select { width: 100%; padding: 15px 15px 15px 50px; background: rgba(255,255,255,0.6); border: 2px solid transparent; border-radius: 50px; font-size: 15px; color: #333; outline: none; transition: 0.3s; appearance: none; }

        .btn-auth { width: 100%; padding: 12px; border: none; border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; transition: 0.3s; color: white; display: block; }
        .btn-login-style { background: linear-gradient(to right, #4facfe, #00f2fe); box-shadow: 0 10px 20px rgba(0, 198, 251, 0.3); }
        .btn-signup-style { background: linear-gradient(to right, #43e97b, #38f9d7); box-shadow: 0 10px 20px rgba(56, 249, 215, 0.3); }
        .btn-otp-style { background: linear-gradient(to right, #fa709a, #fee140); box-shadow: 0 10px 20px rgba(250, 112, 154, 0.3); }
        .btn-auth:active { transform: scale(0.98); }
        .link-btn { margin-top: 12px; text-align: center; font-weight: 600; color: #333; cursor: pointer; font-size: 14px; }

        #side-panel { transition: transform 0.4s; transform: translateX(100%); }
        #side-panel.open { transform: translateX(0); }
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        .line-clamp-custom {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
        }
    </style>
</head>
<body class="text-gray-900 relative overflow-x-hidden">

<div id="ptr-container" class="fixed top-0 left-0 w-full flex justify-center pointer-events-none z-50 transition-transform duration-200" style="transform: translateY(-120px);">
    <div class="mt-4 flex flex-col items-center">
        <img src="https://i.ibb.co/z1jXcZX/Screenshot-2025-11-22-at-2-45-03-PM-removebg-preview.png" class="w-20 h-20 object-contain animate-bounce drop-shadow-2xl">
        <span class="text-[12px] font-black text-purple-600 mt-1" style="text-shadow: 0 2px 4px rgba(255,255,255,0.8);">Refreshing...</span>
    </div>
</div>

<div id="auth-screen">
    <div class="auth-container">
        <img src="https://i.ibb.co/z1jXcZX/Screenshot-2025-11-22-at-2-45-03-PM-removebg-preview.png" class="doll-main" alt="Doll">
        <img src="https://i.ibb.co/jvZs6MnK/Screenshot-2025-11-22-at-2-48-15-PM-removebg-preview.png" class="char-yellow" alt="Yellow">
        <img src="https://i.ibb.co/bRQqTjqn/IMAGE-2025-11-25-21-49-34-removebg-preview.png" class="char-orange" alt="Orange">
        <div class="login-card">
            <img src="https://i.ibb.co/ycwwnZD1/Screenshot-2025-11-22-at-2-48-21-PM-removebg-preview.png" class="icon-lock-img" alt="Lock">
            <div id="form-login" class="auth-form">
                <h2 class="auth-h2">Zobbly</h2>
                <div class="input-group"><div class="input-wrapper"><i class="fas fa-envelope"></i><input type="email" id="loginEmail" placeholder="Email Address" /></div></div>
                <div class="input-group"><div class="input-wrapper"><i class="fas fa-lock"></i><input type="password" id="loginPass" placeholder="Password" /></div></div>
                <button class="btn-auth btn-login-style" onclick="APIService.auth.login()">Enter World</button>
                <button class="btn-auth btn-signup-style" onclick="switchAuth('form-register')">Join Network</button>
                <div class="link-btn" onclick="switchAuth('form-forgot')">Forgot Password?</div>
            </div>

            <div id="form-register" class="auth-form hidden-screen">
                <h2 class="auth-h2">Join</h2>
                <div class="input-group"><div class="input-wrapper"><i class="fas fa-user"></i><input type="text" id="regName" placeholder="Full Name" /></div></div>
                <div class="input-group"><div class="input-wrapper"><i class="fas fa-at"></i><input type="text" id="regUsername" placeholder="Username (Unique)" /></div></div>
                <div class="input-group"><div class="input-wrapper"><i class="fas fa-envelope"></i><input type="email" id="regEmail" placeholder="Email Address" /></div></div>
                <div class="input-group"><div class="input-wrapper"><i class="fas fa-lock"></i><input type="password" id="regPass" placeholder="Password" /></div></div>
                <div class="input-group">
                    <div class="input-wrapper">
                        <i class="fas fa-globe"></i>
                        <select id="regCountry" class="cursor-pointer">
                            <option value="India" selected>India</option>
                            <option value="USA">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="Canada">Canada</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <button class="btn-auth btn-signup-style" onclick="APIService.auth.register()">Sign Up & Verify</button>
                <div class="link-btn" onclick="switchAuth('form-login')">Back to Login</div>
            </div>

            <div id="form-forgot" class="auth-form hidden-screen">
                <h2 class="auth-h2">Reset</h2>
                <div class="input-group"><div class="input-wrapper"><i class="fas fa-envelope"></i><input type="email" id="forgotEmail" placeholder="Enter Email" /></div></div>
                <button class="btn-auth btn-otp-style" onclick="APIService.auth.sendOtp('forgot')">Send OTP</button>
                <div class="link-btn" onclick="switchAuth('form-login')">Back</div>
            </div>
            <div id="form-otp" class="auth-form hidden-screen">
                <h2 class="auth-h2">Verify</h2>
                <p class="text-center text-xs mb-2">Code sent to: <span id="displayEmail" class="font-bold"></span></p>
                <div class="input-group"><div class="input-wrapper"><i class="fas fa-key"></i><input type="text" id="otpCode" placeholder="Enter OTP" /></div></div>
                <button class="btn-auth btn-login-style" onclick="APIService.auth.verifyOtp()">Verify</button>
                <div class="link-btn" onclick="switchAuth('form-login')">Cancel</div>
            </div>
            <div id="form-reset" class="auth-form hidden-screen">
                <h2 class="auth-h2">New Pass</h2>
                <div class="input-group"><div class="input-wrapper"><i class="fas fa-lock"></i><input type="password" id="newPassInput" placeholder="New Password" /></div></div>
                <button class="btn-auth btn-login-style" onclick="APIService.auth.resetPassword()">Update</button>
            </div>
        </div>
    </div>
</div>

<div id="app-screen" class="hidden-screen">
    <header class="glass-header-top fixed top-0 w-full z-40 h-14 flex items-center justify-between px-4 md:px-8">
        <div class="text-2xl font-black tracking-tighter cursor-pointer text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600" onclick="renderView('feed')">Zobbly</div>
        <button onclick="toggleSidePanel()" class="text-xl text-gray-600 p-2"><i class="fa-solid fa-bars"></i></button>
    </header>

    <nav class="glass-nav-bottom fixed bottom-0 w-full z-50 h-16 flex items-center justify-around px-2 
                md:top-14 md:left-0 md:w-64 md:h-[calc(100vh-56px)] md:flex-col md:justify-start md:pt-8 md:items-start md:px-4">
        
        <div class="nav-item nav-active cursor-pointer group" id="nav-feed" onclick="renderView('feed')">
            <div class="text-xl mb-0.5 md:mb-0 md:mr-3"><i class="fa-solid fa-house-chimney"></i></div>
            <span class="hidden md:block font-bold text-sm">Feed</span>
        </div>
        
        <div class="nav-item cursor-pointer group" id="nav-jobs" onclick="renderView('jobs')">
            <div class="text-xl mb-0.5 md:mb-0 md:mr-3"><i class="fa-solid fa-briefcase"></i></div>
            <span class="hidden md:block font-bold text-sm">Jobs</span>
        </div>
        
        <div class="nav-item cursor-pointer relative group" id="nav-notifs" onclick="renderView('notifications')">
            <div class="text-xl mb-0.5 md:mb-0 md:mr-3"><i class="fa-solid fa-bell"></i></div>
            <span class="hidden md:block font-bold text-sm">Notifications</span>
            <span id="notif-badge" class="absolute top-3 right-3 md:top-2 md:left-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden animate-ping"></span>
            <span id="notif-badge-static" class="absolute top-3 right-3 md:top-2 md:left-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
        </div>
        
        <div class="nav-item cursor-pointer group" id="nav-chat" onclick="renderView('chat')">
            <div class="text-xl mb-0.5 md:mb-0 md:mr-3"><i class="fa-solid fa-comment-dots"></i></div>
            <span class="hidden md:block font-bold text-sm">Messages</span>
        </div>
        
        <div class="nav-item cursor-pointer group" id="nav-profile" onclick="renderView('profile')">
            <div class="text-xl mb-0.5 md:mb-0 md:mr-3"><i class="fa-solid fa-circle-user"></i></div>
            <span class="hidden md:block font-bold text-sm">Profile</span>
        </div>
    </nav>

    <div class="max-w-md mx-auto pt-16 pb-20 px-2 min-h-screen md:ml-64 md:max-w-3xl md:px-8 md:pt-20">
        <div class="grid grid-cols-1 gap-4">
            <div class="col-span-1" id="main-content"></div>
        </div>
    </div>

    <div id="side-panel" class="fixed top-0 right-0 h-full w-72 glass-card z-50 p-6 rounded-none border-l border-white/50 bg-white/95 backdrop-blur-xl shadow-2xl">
        <div class="flex justify-between items-center mb-10 pt-4">
            <h2 id="lbl-settings" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600">Settings</h2>
            <button onclick="toggleSidePanel()" class="text-2xl text-gray-500 hover:rotate-90 transition-transform"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="space-y-4">
            <button onclick="openEditProfile()" class="w-full text-left p-4 hover:bg-white/50 rounded-xl flex items-center gap-4 transition"><i class="fa-solid fa-pen-to-square text-purple-500"></i> <span id="lbl-edit-profile">Edit Profile</span></button>
            <button onclick="backupData()" class="w-full text-left p-4 hover:bg-white/50 rounded-xl flex items-center gap-4 transition"><i class="fa-solid fa-cloud-arrow-down text-blue-500"></i> <span id="lbl-backup">Backup Data</span></button>
            <div class="h-px bg-gray-300 my-4"></div>
            <button onclick="deleteAccount()" class="w-full text-left p-4 text-red-600 hover:bg-red-50 rounded-xl flex items-center gap-4 transition"><i class="fa-solid fa-trash"></i> <span id="lbl-delete">Delete Account</span></button>
            <button onclick="APIService.auth.logout()" class="w-full text-left p-4 text-gray-600 hover:bg-gray-100 rounded-xl flex items-center gap-4 transition"><i class="fa-solid fa-right-from-bracket"></i> <span id="lbl-logout">Logout</span></button>
        </div>
    </div>
</div>

<div id="postModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center">
    <div class="glass-card w-11/12 md:max-w-lg p-6 relative shadow-2xl animate-pop-view" style="background:white">
        <button onclick="document.getElementById('postModal').classList.add('hidden')" class="absolute top-4 right-4 text-xl"><i class="fa-solid fa-xmark"></i></button>
        <h2 id="lbl-create-post" class="text-xl font-bold mb-4">Create Post</h2>
        <textarea id="postContent" class="w-full bg-gray-50 p-4 rounded-xl mb-4 outline-none focus:ring-2 ring-purple-200" rows="4" placeholder="What's happening?"></textarea>
        <div class="mb-4">
            <div class="flex items-center bg-gray-50 rounded-xl px-3 border border-transparent focus-within:border-purple-300 focus-within:ring-2 ring-purple-100 transition">
                <i class="fa-solid fa-link text-gray-400 mr-2"></i>
                <input id="postLink" class="w-full bg-transparent p-3 outline-none text-sm" placeholder="Paste link here (http://...)">
            </div>
        </div>
        <div class="flex justify-between items-center">
            <input type="file" id="postImage" class="text-sm text-gray-500 w-1/2">
            <button id="lbl-btn-post" onclick="submitPost()" class="btn-zobbly px-6 py-2 rounded-full font-bold text-sm">Post</button>
        </div>
    </div>
</div>

<div id="editProfileModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center">
    <div class="glass-card w-11/12 md:max-w-md p-6 relative animate-pop-view" style="background:white">
        <button onclick="document.getElementById('editProfileModal').classList.add('hidden')" class="absolute top-4 right-4 text-xl"><i class="fa-solid fa-xmark"></i></button>
        <h2 id="lbl-edit-header" class="text-xl font-bold mb-4">Edit Profile</h2>
        <input id="editName" placeholder="Full Name" class="w-full mb-3 p-3 bg-gray-50 rounded-xl border-none">
        <input id="editHeadline" placeholder="Headline / Bio" class="w-full mb-3 p-3 bg-gray-50 rounded-xl border-none">

        <label class="text-sm font-bold text-gray-600 mb-1 block ml-1">App Language</label>
        <select id="editLang" class="w-full mb-4 p-3 bg-gray-50 rounded-xl border-none cursor-pointer">
            <option value="en">English</option>
            <option value="hi">Hindi (हिंदी)</option>
            <option value="es">Spanish (Español)</option>
            <option value="fr">French (Français)</option>
            <option value="de">German (Deutsch)</option>
            <option value="zh">Chinese (中文)</option>
            <option value="ja">Japanese (日本語)</option>
            <option value="ru">Russian (Русский)</option>
            <option value="pt">Portuguese (Português)</option>
            <option value="ar">Arabic (العربية)</option>
            <option value="it">Italian (Italiano)</option>
            <option value="ko">Korean (한국어)</option>
            <option value="tr">Turkish (Türkçe)</option>
            <option value="nl">Dutch (Nederlands)</option>
            <option value="pl">Polish (Polski)</option>
            <option value="id">Indonesian (Bahasa Indonesia)</option>
            <option value="vi">Vietnamese (Tiếng Việt)</option>
            <option value="th">Thai (ไทย)</option>
            <option value="bn">Bengali (বাংলা)</option>
            <option value="pa">Punjabi (ਪੰਜਾਬੀ)</option>
            <option value="ur">Urdu (اردو)</option>
        </select>

        <button id="lbl-save-changes" onclick="saveProfile()" class="btn-zobbly w-full py-2 rounded-xl">Save Changes</button>
    </div>
</div>

<div id="genericModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center">
    <div class="glass-card w-11/12 md:max-w-2xl p-6 relative shadow-2xl animate-pop-view h-auto max-h-[90vh]" style="background: white;">
        <button onclick="closeModal()" class="absolute top-2 right-4 text-xl z-20"><i class="fa-solid fa-xmark"></i></button>
        <div id="modalContent" class="h-full"></div>
    </div>
</div>

<div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full shadow-2xl transition duration-300 z-50 border border-gray-700 flex items-center gap-3 opacity-0 pointer-events-none" style="width: max-content;">
    <i class="fa-solid fa-bell text-yellow-400"></i><span id="toast-msg">Notification</span>
</div>

<script>
    const API_BASE = "https://zobbly.onrender.com";
    let activeChatUser = null;
    let myFollowers = [];
    let myFollowing = [];
    let myBlockedUsers = [];
    let authContext = "";

    /* --- TRANSLATION DATA --- */
    const translations = {
        en: { settings: "Settings", editProfile: "Edit Profile", backup: "Backup Data", delete: "Delete Account", logout: "Logout", createPost: "Create Post", post: "Post", save: "Save Changes", experience: "Experience", activity: "Activity", followers: "Followers", following: "Following", follow: "Follow", unfollow: "Following", block: "Block", unblock: "Unblock", report: "Report", jobs: "Find Jobs", search: "Search", notifications: "Notifications", noPosts: "No posts yet.", back: "Back", message: "Message", clear: "Clear" },
        hi: { settings: "सेटिंग्स", editProfile: "प्रोफाइल बदलें", backup: "डाटा बैकअप", delete: "अकाउंट हटाएं", logout: "लॉग आउट", createPost: "पोस्ट बनाएं", post: "पोस्ट करें", save: "बदलाव सेव करें", experience: "अनुभव", activity: "गतिविधि", followers: "फॉलोअर्स", following: "फॉलोइंग", follow: "फॉलो करें", unfollow: "फॉलोइंग", block: "ब्लॉक करें", unblock: "अनब्लॉक", report: "रिपोर्ट", jobs: "नौकरी खोजें", search: "खोजें", notifications: "सूचनाएं", noPosts: "कोई पोस्ट नहीं", back: "वापस", message: "मैसेज", clear: "साफ़ करें" },
        es: { settings: "Ajustes", editProfile: "Editar Perfil", backup: "Copia Seguridad", delete: "Borrar Cuenta", logout: "Cerrar Sesión", createPost: "Crear Publicación", post: "Publicar", save: "Guardar", experience: "Experiencia", activity: "Actividad", followers: "Seguidores", following: "Siguiendo", follow: "Seguir", unfollow: "Siguiendo", block: "Bloquear", unblock: "Desbloquear", report: "Reportar", jobs: "Buscar Empleo", search: "Buscar", notifications: "Notificaciones", noPosts: "Sin publicaciones", back: "Atrás", message: "Mensaje", clear: "Limpiar" },
        fr: { settings: "Paramètres", editProfile: "Modifier Profil", backup: "Sauvegarde", delete: "Supprimer Compte", logout: "Déconnexion", createPost: "Créer Post", post: "Publier", save: "Enregistrer", experience: "Expérience", activity: "Activité", followers: "Abonnés", following: "Abonnements", follow: "Suivre", unfollow: "Suivi", block: "Bloquer", unblock: "Débloquer", report: "Signaler", jobs: "Emplois", search: "Chercher", notifications: "Notifications", noPosts: "Aucun post", back: "Retour", message: "Message", clear: "Effacer" },
        de: { settings: "Einstellungen", editProfile: "Profil Bearbeiten", backup: "Datensicherung", delete: "Konto Löschen", logout: "Abmelden", createPost: "Beitrag Erstellen", post: "Posten", save: "Speichern", experience: "Erfahrung", activity: "Aktivität", followers: "Follower", following: "Folgt", follow: "Folgen", unfollow: "Folgend", block: "Blockieren", unblock: "Entblocken", report: "Melden", jobs: "Jobs Finden", search: "Suchen", notifications: "Benachrichtigungen", noPosts: "Keine Beiträge", back: "Zurück", message: "Nachricht", clear: "Löschen" },
        zh: { settings: "设置", editProfile: "编辑个人资料", backup: "备份数据", delete: "删除帐户", logout: "登出", createPost: "创建帖子", post: "发布", save: "保存更改", experience: "经验", activity: "活动", followers: "粉丝", following: "关注", follow: "关注", unfollow: "已关注", block: "拉黑", unblock: "取消拉黑", report: "举报", jobs: "找工作", search: "搜索", notifications: "通知", noPosts: "暂无帖子", back: "返回", message: "消息", clear: "清除" },
        ja: { settings: "設定", editProfile: "プロフィール編集", backup: "データバックアップ", delete: "アカウント削除", logout: "ログアウト", createPost: "投稿を作成", post: "投稿", save: "保存", experience: "経験", activity: "アクティビティ", followers: "フォロワー", following: "フォロー中", follow: "フォロー", unfollow: "フォロー中", block: "ブロック", unblock: "ブロック解除", report: "報告", jobs: "仕事を探す", search: "検索", notifications: "通知", noPosts: "投稿なし", back: "戻る", message: "メッセージ", clear: "クリア" },
        ru: { settings: "Настройки", editProfile: "Ред. профиль", backup: "Резервная копия", delete: "Удалить аккаунт", logout: "Выйти", createPost: "Создать пост", post: "Опубликовать", save: "Сохранить", experience: "Опыт", activity: "Активность", followers: "Подписчики", following: "Подписки", follow: "Подписаться", unfollow: "Подписан", block: "Блокировать", unblock: "Разблокировать", report: "Пожаловаться", jobs: "Найти работу", search: "Поиск", notifications: "Уведомления", noPosts: "Нет постов", back: "Назад", message: "Сообщение", clear: "Очистить" },
        pt: { settings: "Configurações", editProfile: "Editar Perfil", backup: "Backup", delete: "Excluir Conta", logout: "Sair", createPost: "Criar Post", post: "Publicar", save: "Salvar", experience: "Experiência", activity: "Atividade", followers: "Seguidores", following: "Seguindo", follow: "Seguir", unfollow: "Seguindo", block: "Bloquear", unblock: "Desbloquear", report: "Reportar", jobs: "Vagas", search: "Buscar", notifications: "Notificações", noPosts: "Sem posts", back: "Voltar", message: "Mensagem", clear: "Limpar" },
        ar: { settings: "الإعدادات", editProfile: "تعديل الملف", backup: "نسخ احتياطي", delete: "حذف الحساب", logout: "تسجيل خروج", createPost: "إنشاء منشور", post: "نشر", save: "حفظ", experience: "الخبرة", activity: "النشاط", followers: "المتابعون", following: "يتابع", follow: "متابعة", unfollow: "يتابع", block: "حظر", unblock: "إلغاء الحظر", report: "إبلاغ", jobs: "وظائف", search: "بحث", notifications: "الإشعارات", noPosts: "لا يوجد منشورات", back: "رجوع", message: "رسالة", clear: "مسح" },
        it: { settings: "Impostazioni", editProfile: "Modifica Profilo", backup: "Backup Dati", delete: "Elimina Account", logout: "Esci", createPost: "Crea Post", post: "Pubblica", save: "Salva", experience: "Esperienza", activity: "Attività", followers: "Follower", following: "Seguiti", follow: "Segui", unfollow: "Seguiti", block: "Blocca", unblock: "Sblocca", report: "Segnala", jobs: "Lavoro", search: "Cerca", notifications: "Notifiche", noPosts: "Nessun post", back: "Indietro", message: "Messaggio", clear: "Pulisci" },
        ko: { settings: "설정", editProfile: "프로필 편집", backup: "백업", delete: "계정 삭제", logout: "로그아웃", createPost: "게시물 작성", post: "게시", save: "저장", experience: "경력", activity: "활동", followers: "팔로워", following: "팔로잉", follow: "팔로우", unfollow: "팔로잉", block: "차단", unblock: "차단 해제", report: "신고", jobs: "채용", search: "검색", notifications: "알림", noPosts: "게시물 없음", back: "뒤로", message: "메시지", clear: "지우기" },
        tr: { settings: "Ayarlar", editProfile: "Profili Düzenle", backup: "Yedekle", delete: "Hesabı Sil", logout: "Çıkış Yap", createPost: "Gönderi Oluştur", post: "Paylaş", save: "Kaydet", experience: "Deneyim", activity: "Aktivite", followers: "Takipçiler", following: "Takip", follow: "Takip Et", unfollow: "Takip Ediliyor", block: "Engelle", unblock: "Engeli Kaldır", report: "Bildir", jobs: "İş Bul", search: "Ara", notifications: "Bildirimler", noPosts: "Gönderi yok", back: "Geri", message: "Mesaj", clear: "Temizle" },
        nl: { settings: "Instellingen", editProfile: "Profiel Bewerken", backup: "Back-up", delete: "Account Verwijderen", logout: "Uitloggen", createPost: "Post Maken", post: "Plaatsen", save: "Opslaan", experience: "Ervaring", activity: "Activiteit", followers: "Volgers", following: "Volgend", follow: "Volgen", unfollow: "Volgend", block: "Blokkeren", unblock: "Deblokkeren", report: "Rapporteren", jobs: "Banen", search: "Zoeken", notifications: "Meldingen", noPosts: "Geen berichten", back: "Terug", message: "Bericht", clear: "Wissen" },
        pl: { settings: "Ustawienia", editProfile: "Edytuj Profil", backup: "Kopia Zapasowa", delete: "Usuń Konto", logout: "Wyloguj", createPost: "Utwórz Post", post: "Opublikuj", save: "Zapisz", experience: "Doświadczenie", activity: "Aktywność", followers: "Obserwujący", following: "Obserwuje", follow: "Obserwuj", unfollow: "Obserwujesz", block: "Zablokuj", unblock: "Odblokuj", report: "Zgłoś", jobs: "Oferty Pracy", search: "Szukaj", notifications: "Powiadomienia", noPosts: "Brak postów", back: "Wróć", message: "Wiadomość", clear: "Wyczyść" },
        id: { settings: "Pengaturan", editProfile: "Edit Profil", backup: "Cadangan", delete: "Hapus Akun", logout: "Keluar", createPost: "Buat Post", post: "Kirim", save: "Simpan", experience: "Pengalaman", activity: "Aktivitas", followers: "Pengikut", following: "Mengikuti", follow: "Ikuti", unfollow: "Mengikuti", block: "Blokir", unblock: "Buka Blokir", report: "Lapor", jobs: "Cari Kerja", search: "Cari", notifications: "Notifikasi", noPosts: "Belum ada post", back: "Kembali", message: "Pesan", clear: "Bersihkan" },
        vi: { settings: "Cài đặt", editProfile: "Sửa hồ sơ", backup: "Sao lưu", delete: "Xóa tài khoản", logout: "Đăng xuất", createPost: "Tạo bài viết", post: "Đăng", save: "Lưu", experience: "Kinh nghiệm", activity: "Hoạt động", followers: "Người theo dõi", following: "Đang theo dõi", follow: "Theo dõi", unfollow: "Đang theo dõi", block: "Chặn", unblock: "Bỏ chặn", report: "Báo cáo", jobs: "Tìm việc", search: "Tìm kiếm", notifications: "Thông báo", noPosts: "Chưa có bài viết", back: "Quay lại", message: "Tin nhắn", clear: "Xóa" },
        th: { settings: "การตั้งค่า", editProfile: "แก้ไขโปรไฟล์", backup: "สำรองข้อมูล", delete: "ลบบัญชี", logout: "ออกจากระบบ", createPost: "สร้างโพสต์", post: "โพสต์", save: "บันทึก", experience: "ประสบการณ์", activity: "กิจกรรม", followers: "ผู้ติดตาม", following: "กำลังติดตาม", follow: "ติดตาม", unfollow: "กำลังติดตาม", block: "บล็อก", unblock: "ปลดบล็อก", report: "รายงาน", jobs: "หางาน", search: "ค้นหา", notifications: "การแจ้งเตือน", noPosts: "ไม่มีโพสต์", back: "กลับ", message: "ข้อความ", clear: "ล้าง" },
        bn: { settings: "সেটিংস", editProfile: "প্রোফাইল এডিট", backup: "ব্যাকআপ", delete: "অ্যাকাউন্ট মুছুন", logout: "লগ আউট", createPost: "পোস্ট করুন", post: "পোস্ট", save: "সেভ করুন", experience: "অভিজ্ঞতা", activity: "কার্যকলাপ", followers: "অনুসারী", following: "অনুসরণ", follow: "ফলো", unfollow: "ফলোয়িং", block: "ব্লক", unblock: "আনব্লক", report: "রিপোর্ট", jobs: "চাকরি", search: "অনুসন্ধান", notifications: "নোটিফিকেশন", noPosts: "কোনো পোস্ট নেই", back: "ফিরে যান", message: "মেসেজ", clear: "মুছুন" },
        pa: { settings: "ਸੈਟਿੰਗਾਂ", editProfile: "ਪ੍ਰੋਫਾਈਲ ਬਦਲੋ", backup: "ਡਾਟਾ ਬੈਕਅਪ", delete: "ਖਾਤਾ ਹਟਾਓ", logout: "ਲੌਗ ਆਉਟ", createPost: "ਪੋਸਟ ਬਣਾਓ", post: "ਪੋਸਟ", save: "ਸੇਵ ਕਰੋ", experience: "ਤਜਰਬਾ", activity: "ਸਰਗਰਮੀ", followers: "ਫਾਲੋਅਰਜ਼", following: "ਫਾਲੋਇੰਗ", follow: "ਫਾਲੋ", unfollow: "ਫਾਲੋਇੰਗ", block: "ਬਲਾਕ", unblock: "ਅਨਬਲਾਕ", report: "ਰਿਪੋਰਟ", jobs: "ਨੌਕਰੀਆਂ", search: "ਖੋਜ", notifications: "ਸੂਚਨਾਵਾਂ", noPosts: "ਕੋਈ ਪੋਸਟ ਨਹੀਂ", back: "ਵਾਪਸ", message: "ਸੁਨੇਹਾ", clear: "ਸਾਫ਼" },
        ur: { settings: "ترتیبات", editProfile: "پروفائل میں ترمیم", backup: "بیک اپ", delete: "اکاؤنٹ حذف کریں", logout: "لاگ آؤٹ", createPost: "پوسٹ بنائیں", post: "پوسٹ", save: "محفوظ کریں", experience: "تجربہ", activity: "سرگرمی", followers: "فالورز", following: "فالوونگ", follow: "فالو کریں", unfollow: "فالوونگ", block: "بلاک", unblock: "ان بلاک", report: "رپورٹ", jobs: "نوکریاں", search: "تلاش", notifications: "اطلاعات", noPosts: "کوئی پوسٹ نہیں", back: "واپس", message: "پیغام", clear: "صاف" }
    };

    function txt(key) {
        const lang = localStorage.getItem("appLang") || "en";
        return (translations[lang] && translations[lang][key]) ? translations[lang][key] : translations["en"][key];
    }

    function applyTranslations() {
        if(document.getElementById('lbl-settings')) document.getElementById('lbl-settings').innerText = txt('settings');
        if(document.getElementById('lbl-edit-profile')) document.getElementById('lbl-edit-profile').innerText = txt('editProfile');
        if(document.getElementById('lbl-backup')) document.getElementById('lbl-backup').innerText = txt('backup');
        if(document.getElementById('lbl-delete')) document.getElementById('lbl-delete').innerText = txt('delete');
        if(document.getElementById('lbl-logout')) document.getElementById('lbl-logout').innerText = txt('logout');
        if(document.getElementById('lbl-create-post')) document.getElementById('lbl-create-post').innerText = txt('createPost');
        if(document.getElementById('lbl-btn-post')) document.getElementById('lbl-btn-post').innerText = txt('post');
        if(document.getElementById('lbl-save-changes')) document.getElementById('lbl-save-changes').innerText = txt('save');
        if(document.getElementById('lbl-edit-header')) document.getElementById('lbl-edit-header').innerText = txt('editProfile');
        document.getElementById('postContent').placeholder = txt('createPost') + "...";
    }

    function formatTimeAgo(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        if (seconds < 60) return 'Just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        if (days < 7) return `${days}d ago`;
        return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    const getHeaders = (isFormData = false) => {
        const token = localStorage.getItem("token");
        const headers = { "x-auth-token": token };
        if (!isFormData) headers["Content-Type"] = "application/json";
        return headers;
    };

    const APIService = {
        auth: {
            login: async () => {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPass').value;
                if(!email || !password) return showToast("Enter credentials");
                try {
                    const res = await fetch(`${API_BASE}/api/login`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, password }) });
                    const data = await res.json();
                    if(res.ok) {
                        localStorage.setItem("token", data.token);
                        localStorage.setItem("userId", data.user._id);
                        localStorage.setItem("userName", data.user.name);
                        localStorage.setItem("userEmail", data.user.email);
                        if(data.user.photo) localStorage.setItem("userPhoto", data.user.photo);
                        localStorage.setItem("userCountry", data.user.country || "India");
                        myBlockedUsers = data.user.blockedUsers || [];
                        checkLoginStatus();
                    } else alert(data.error);
                } catch(e) { alert("Server connection failed. Is server.js running?"); }
            },
            register: async () => {
                const name = document.getElementById('regName').value;
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPass').value;
                const username = document.getElementById('regUsername').value;
                const country = document.getElementById('regCountry').value;

                if(!name || !email || !password || !username) return showToast("Fill all fields");
                try {
                    const res = await fetch(`${API_BASE}/api/register`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, email, password, username, country }) });
                    if(res.ok) {
                        authContext = 'register';
                        APIService.auth.sendOtp('register', email);
                    } else {
                        const errData = await res.json();
                        alert(errData.error || "Registration Failed");
                    }
                } catch(e) { showToast("Server Error"); }
            },
            sendOtp: async (context, emailParam) => {
                const email = emailParam || document.getElementById('forgotEmail').value;
                const type = context || 'forgot';
                authContext = type;
                try {
                    const res = await fetch(`${API_BASE}/api/send-otp`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, type }) });
                    if(res.ok) {
                        localStorage.setItem("tempEmail", email);
                        document.getElementById('displayEmail').innerText = email;
                        switchAuth('form-otp');
                        showToast("OTP Sent!");
                    } else alert("Error sending OTP");
                } catch(e) { showToast("Server Error"); }
            },
            verifyOtp: async () => {
                const otp = document.getElementById('otpCode').value;
                const email = localStorage.getItem("tempEmail");
                try {
                    const res = await fetch(`${API_BASE}/api/verify-otp`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, otp }) });
                    if(res.ok) {
                        showToast("Verified!");
                        if(authContext === 'forgot') {
                            switchAuth('form-reset');
                        } else {
                            switchAuth('form-login');
                            alert("Account Verified! Please Login.");
                        }
                    } else showToast("Invalid OTP");
                } catch(e) { showToast("Error"); }
            },
            resetPassword: async () => {
                const newPassword = document.getElementById('newPassInput').value;
                const email = localStorage.getItem("tempEmail");
                try {
                    const res = await fetch(`${API_BASE}/api/reset-password`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, newPassword }) });
                    if(res.ok) {
                        showToast("Password Updated!");
                        switchAuth('form-login');
                    }
                } catch(e) { showToast("Error"); }
            },
            logout: () => { localStorage.clear(); location.reload(); }
        },
        user: {
            getProfile: async (id) => (await fetch(`${API_BASE}/api/user/profile/${id}`)).json(),
            follow: async (id) => (await fetch(`${API_BASE}/api/user/follow/${id}`, { method: "PUT", headers: getHeaders() })).json(),
            update: async (name, headline) => { await fetch(`${API_BASE}/api/user/update`, { method: "PUT", headers: getHeaders(), body: JSON.stringify({name, headline}) }); },
            delete: async () => { await fetch(`${API_BASE}/api/user/delete`, { method: "DELETE", headers: getHeaders() }); },

            uploadPhoto: async (file) => {
                if(!file) return;
                const fd = new FormData();
                fd.append("photo", file);
                showToast("Uploading...");
                const res = await fetch(`${API_BASE}/api/user/upload-photo`, { method: "POST", headers: { "x-auth-token": localStorage.getItem("token") }, body: fd });
                if(res.ok) {
                    showToast("Photo Updated!");
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast("Upload Failed");
                }
            },

            backup: async () => { const res = await fetch(`${API_BASE}/api/user/backup`, { headers: getHeaders() }); const data = await res.json(); const blob = new Blob([JSON.stringify(data)], {type:"application/json"}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="backup.json"; a.click(); },
            block: async (id) => { const res = await fetch(`${API_BASE}/api/user/block/${id}`, { method: "PUT", headers: getHeaders() }); return await res.json(); },
            addExperience: async (expData) => { await fetch(`${API_BASE}/api/user/add-experience`, { method: "POST", headers: getHeaders(), body: JSON.stringify({ userId: localStorage.getItem("userId"), experienceData: expData }) }); },
            editExperience: async (id, expData) => { await fetch(`${API_BASE}/api/user/experience/${id}`, { method: "PUT", headers: getHeaders(), body: JSON.stringify(expData) }); },
            deleteExperience: async (id) => { await fetch(`${API_BASE}/api/user/experience/${id}`, { method: "DELETE", headers: getHeaders() }); },
        },
        feed: {
            create: async(fd) => fetch(`${API_BASE}/api/posts/create`, {method:"POST", headers: { "x-auth-token": localStorage.getItem("token") }, body:fd}),
            getAll: async() => {
                const res = await fetch(`${API_BASE}/api/posts?t=${new Date().getTime()}`, {headers: getHeaders()});
                if(!res.ok) throw new Error("Feed Error");
                return res.json();
            },
            getMyPosts: async() => (await fetch(`${API_BASE}/api/my-posts`, {headers:getHeaders()})).json(),
            like: async(id) => fetch(`${API_BASE}/api/posts/like/${id}`, {method:"PUT", headers:getHeaders()}),
            comment: async(id, text) => fetch(`${API_BASE}/api/posts/comment/${id}`, {method:"POST", headers:getHeaders(), body:JSON.stringify({text})}),
            delete: async(id) => fetch(`${API_BASE}/api/posts/${id}`, {method:"DELETE", headers:getHeaders()}),
            deleteComment: async(postId, commentId) => fetch(`${API_BASE}/api/posts/comment/${postId}/${commentId}`, { method: "DELETE", headers: getHeaders() })
        },
        chat: {
            search: async (q) => (await fetch(`${API_BASE}/api/search?q=${q}`, { headers: getHeaders() })).json(),
            send: async (rid, txt) => fetch(`${API_BASE}/api/messages`, { method:"POST", headers:getHeaders(), body:JSON.stringify({receiverId:rid, content:txt}) }),
            upload: async (fd) => fetch(`${API_BASE}/api/messages/upload`, { method: "POST", headers: { "x-auth-token": localStorage.getItem("token") }, body: fd }),
            getHistory: async(id) => (await fetch(`${API_BASE}/api/messages/${id}`, { headers: getHeaders() })).json(),
            deleteMsg: async (id) => { await fetch(`${API_BASE}/api/messages/${id}`, { method: "DELETE", headers: getHeaders() }); },
            clearChat: async (id) => { await fetch(`${API_BASE}/api/messages/clear/${id}`, { method: "DELETE", headers: getHeaders() }); },
            getConversations: async() => (await fetch(`${API_BASE}/api/chat/conversations`, { headers: getHeaders() })).json()
        },
        notifications: {
            getAll: async () => (await fetch(`${API_BASE}/api/notifications`, { headers: getHeaders() })).json(),
            delete: async (id) => {
                const res = await fetch(`${API_BASE}/api/notifications/${id}`, { method: "DELETE", headers: getHeaders() });
                if (!res.ok) throw new Error("Delete failed");
                return res.json();
            }
        },
        jobs: {
            search: async (endpoint) => (await fetch(`${API_BASE}/api${endpoint}`)).json()
        }
    };

    async function downloadImage(url) {
        try {
            showToast("Saving...");
            const response = await fetch(url);
            const blob = await response.blob();
            const reader = new FileReader();
            reader.onloadend = function() {
                const base64data = reader.result;
                const link = document.createElement('a');
                link.href = base64data;
                link.download = `zobbly_${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            reader.readAsDataURL(blob);
        } catch (e) {
            console.error("Download failed", e);
            showToast("Error saving image");
            window.open(url, '_blank');
        }
    }

    let ptrStartY = 0; let ptrCurrentY = 0; let ptrEnabled = false;
    const ptrElement = document.getElementById('ptr-container');
    document.addEventListener('touchstart', e => { if(window.scrollY === 0) { ptrStartY = e.touches[0].screenY; ptrEnabled = true; } else { ptrEnabled = false; } }, {passive: true});
    document.addEventListener('touchmove', e => { if(ptrEnabled && window.scrollY === 0) { ptrCurrentY = e.touches[0].screenY; let diff = ptrCurrentY - ptrStartY; if(diff > 0) { let translateVal = Math.min(diff/2.5, 120) - 120; ptrElement.style.transform = `translateY(${translateVal}px)`; } } }, {passive: true});
    document.addEventListener('touchend', async e => { if(ptrEnabled && window.scrollY === 0) { let diff = ptrCurrentY - ptrStartY; if(diff > 150) { ptrElement.style.transform = `translateY(20px)`; try { await renderView('feed'); } catch(err) { console.log(err); } setTimeout(() => { ptrElement.style.transform = `translateY(-120px)`; }, 800); } else { ptrElement.style.transform = `translateY(-120px)`; } } ptrEnabled = false; ptrStartY = 0; ptrCurrentY = 0; });

    async function checkLoginStatus() {
        if(localStorage.getItem("token")) {
            document.getElementById('auth-screen').classList.add('hidden-screen');
            document.getElementById('app-screen').classList.remove('hidden-screen');
            applyTranslations();
            await updateMyStats();
            renderView('feed');
            setInterval(checkNotifs, 10000);
        }
    }

    async function updateMyStats() {
        try {
            const data = await APIService.user.getProfile(localStorage.getItem("userId"));
            myFollowing = data.user.following || [];
            if(data.user.blockedUsers) myBlockedUsers = data.user.blockedUsers;
        } catch(e){}
    }

    async function checkNotifs() {
        try {
            const notifs = await APIService.notifications.getAll();
            const unread = notifs.filter(n => !n.isRead).length;
            if(unread > 0) {
                document.getElementById('notif-badge').classList.remove('hidden');
                document.getElementById('notif-badge-static').classList.remove('hidden');
            } else {
                document.getElementById('notif-badge').classList.add('hidden');
                document.getElementById('notif-badge-static').classList.add('hidden');
            }
        } catch(e){}
    }

    function switchAuth(id) { document.querySelectorAll('.auth-form').forEach(e=>e.classList.add('hidden-screen')); document.getElementById(id).classList.remove('hidden-screen'); }
    function toggleSidePanel() { document.getElementById('side-panel').classList.toggle('open'); }

    function renderView(view) {
        const c = document.getElementById('main-content');
        c.innerHTML = '<div class="text-center mt-20"><i class="fa-solid fa-spinner fa-spin text-4xl text-purple-600"></i></div>';
        c.className = "col-span-1 animate-pop-view";

        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-active', 'text-purple-600'));
        let activeBtnId = `nav-${view}`;
        if(document.getElementById(activeBtnId)) document.getElementById(activeBtnId).classList.add('nav-active', 'text-purple-600');

        if(window.chatInterval) clearInterval(window.chatInterval);

        if(view === 'feed') renderFeed(c);
        else if(view === 'jobs') renderJobs(c);
        else if(view === 'chat') renderChat(c);
        else if(view === 'profile') viewUserProfile(localStorage.getItem("userId"));
        else if(view === 'notifications') renderNotifications(c);
    }

    // --- NEW: Single Post View Function ---
    async function viewSinglePost(postId) {
        const c = document.getElementById('main-content');
        c.innerHTML = '<div class="text-center mt-20"><i class="fa-solid fa-spinner fa-spin text-4xl text-purple-600"></i></div>';
        try {
            const posts = await APIService.feed.getAll();
            const p = posts.find(item => item._id === postId);
            const myId = localStorage.getItem("userId");

            if (p) {
                let html = `
                <div class="flex items-center gap-2 mb-4">
                    <button onclick="renderView('feed')" class="text-sm text-gray-500 hover:text-black bg-white/50 px-3 py-1 rounded-full shadow-sm"><i class="fa-solid fa-arrow-left"></i> ${txt('back')}</button>
                    <h2 class="font-bold text-lg">${txt('post')}</h2>
                </div>`;

                const liked = p.likes.includes(myId);
                const isMe = p.userId?._id === myId;
                const isLongText = p.content.length > 200 || (p.content.match(/\n/g) || []).length > 4;
                const contentId = `post-content-${p._id}`;
                let linkHtml = '';
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const detectedLinks = p.content.match(urlRegex);
                if(detectedLinks && detectedLinks.length > 0) {
                      const firstLink = detectedLinks[0];
                      linkHtml = `<button onclick="openLink('${firstLink}')" class="w-full mt-2 mb-2 bg-purple-50 text-purple-600 p-2 rounded-lg text-xs font-bold border border-purple-100 flex items-center gap-2"><i class="fa-solid fa-link"></i> Open Link</button>`;
                }

                const userName = p.userId?.name || "Deleted User";
                const userPhoto = p.userId?.photo || "https://placehold.co/50";
                const userHandle = p.userId?.username ? `@${p.userId.username}` : '';
                const userCountry = p.userId?.country ? `<span class="ml-1 text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500"><i class="fa-solid fa-earth-americas"></i> ${p.userId.country}</span>` : '';
                const userId = p.userId?._id || '';

                html += `<div class="glass-card mb-4 p-4 relative">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <img src="${userPhoto}" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm cursor-pointer" onclick="${userId ? `viewUserProfile('${userId}')` : ''}">
                                <div>
                                    <h3 class="font-bold text-gray-800 text-sm cursor-pointer hover:underline flex items-center gap-1" onclick="${userId ? `viewUserProfile('${userId}')` : ''}">
                                        ${userName}
                                        <span class="text-xs text-gray-400 font-normal hidden sm:inline">${userHandle}</span>
                                        ${userCountry}
                                    </h3>
                                    <div class="flex items-center gap-1.5">
                                        <p class="text-[10px] text-gray-500">${p.userId?.headline || 'Member'}</p>
                                        <span class="text-[8px] text-gray-300">•</span>
                                        <p class="text-[10px] text-gray-400 font-medium">${formatTimeAgo(p.createdAt || new Date())}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="${contentId}" class="text-gray-800 mb-2 text-sm whitespace-pre-line break-words ${isLongText ? 'line-clamp-custom' : ''}">${p.content}</div>
                        ${isLongText ? `<button onclick="toggleSeeMore('${contentId}', this)" class="text-purple-600 text-xs font-bold mb-2 hover:underline">See more...</button>` : ''}
                        ${linkHtml}
                        ${p.image ? `<img src="${p.image}" class="w-full rounded-xl mb-3 object-cover max-h-80 shadow-sm mt-2">` : ''}
                        <div class="flex items-center gap-6 border-t border-gray-200/50 pt-3">
                            <button onclick="toggleLike('${p._id}')" class="flex items-center gap-2 ${liked?'text-red-500 font-bold':'text-gray-500'} text-sm"><i class="fa-solid fa-heart"></i> ${p.likes.length}</button>
                            <button onclick="toggleComment('${p._id}')" class="flex items-center gap-2 text-gray-500 text-sm"><i class="fa-solid fa-comment"></i> ${p.comments.length}</button>
                        </div>
                        <div id="comments-${p._id}" class="mt-3 pt-3 border-t border-gray-200/50">
                            <div class="max-h-64 overflow-y-auto mb-2 space-y-3 px-1">
                                ${p.comments.map(cm => {
                                    const canDelete = isMe || (cm.userId && cm.userId._id === myId);
                                    return `
                                    <div class="flex gap-2 items-start group">
                                        <img src="${cm.userId?.photo || 'https://placehold.co/30'}" class="w-8 h-8 rounded-full border border-gray-200 mt-1 object-cover cursor-pointer" onclick="${cm.userId ? `viewUserProfile('${cm.userId._id}')` : ''}">
                                        <div class="bg-gray-100 p-2.5 rounded-2xl rounded-tl-none relative w-full max-w-[85%]">
                                            <div class="flex justify-between items-center mb-0.5">
                                                <span class="font-bold text-xs text-gray-900 cursor-pointer hover:underline" onclick="${cm.userId ? `viewUserProfile('${cm.userId._id}')` : ''}">${cm.userName}</span>
                                                ${canDelete ? `<button onclick="deleteComment('${p._id}', '${cm._id}')" class="text-gray-400 hover:text-red-500 text-[10px]"><i class="fa-solid fa-trash"></i></button>` : ''}
                                            </div>
                                            <p class="text-xs text-gray-700 leading-snug">${cm.text}</p>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                             <div class="flex gap-2 items-center bg-gray-50 p-1.5 rounded-full border">
                                <input id="inp-${p._id}" type="text" class="w-full p-2 text-sm bg-transparent outline-none" placeholder="Write a comment...">
                                <button onclick="postComment('${p._id}')" class="bg-purple-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md hover:bg-purple-700 transition">
                                    <i class="fa-solid fa-paper-plane text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;

                c.innerHTML = html;
            } else {
                c.innerHTML = '<div class="text-center text-gray-500 mt-10">Post not found or deleted. <br><button onclick="renderView(\'feed\')" class="mt-4 text-purple-600 font-bold">Go to Feed</button></div>';
            }
        } catch(e) {
            console.error(e);
            c.innerHTML = '<div class="text-center text-red-500 mt-10">Error loading post.</div>';
        }
    }

    // --- UPDATED: HANDLE NOTIFICATION CLICK (DEEP LINKING) ---
    function handleNotifClick(type, relatedId, actorId) {
        if(type === 'message') {
            if(actorId) {
                APIService.user.getProfile(actorId).then(data => {
                    startChat(actorId, data.user.name, data.user.photo);
                    renderView('chat');
                }).catch(() => renderView('chat'));
            } else {
                renderView('chat');
            }
        }
        else if(type === 'follow') {
             viewUserProfile(actorId);
        }
        else if(type === 'like' || type === 'comment' || type === 'post') {
            viewSinglePost(relatedId);
        }
        else {
            renderView('feed');
        }
    }

    // --- FUNCTION TO DELETE COMMENT ---
    async function deleteComment(postId, commentId) {
        if(!confirm("Delete this comment?")) return;
        try {
            await APIService.feed.deleteComment(postId, commentId);
            showToast("Comment Deleted");

            // Refresh view based on where user is
            const mainContent = document.getElementById('main-content');
            if(mainContent.innerHTML.includes('Back to Feed')) {
                viewSinglePost(postId); // Refresh single post view
            } else if(mainContent.innerHTML.includes('id="profile-view"')) {
                viewUserProfile(localStorage.getItem('userId')); // Refresh profile view if on profile
            } else {
                renderView('feed'); // Refresh main feed
            }
        } catch(e) {
            showToast("Error deleting comment");
        }
    }

    // --- UPDATED FEED RENDER WITH SHUFFLE LOGIC ---
    async function renderFeed(c) {
        const topBar = `
            <div class="glass-card p-3 mb-4 flex gap-2 items-center sticky top-14 z-30">
                <button onclick="document.getElementById('postModal').classList.remove('hidden')" class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex-shrink-0 flex items-center justify-center text-white shadow-md active:scale-95 transition"><i class="fa-solid fa-pen-nib"></i></button>
                <div class="flex-1 relative"><input id="feedSearchInput" type="text" placeholder="${txt('search')}..." class="w-full bg-white/50 border border-gray-200 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-400 transition" onkeypress="handleEnterSearch(event)"></div>
                <button onclick="searchUsersFromFeed()" class="w-10 h-10 bg-gray-100 text-purple-600 rounded-full flex-shrink-0 flex items-center justify-center shadow-sm hover:bg-purple-100 transition"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>`;
        c.innerHTML = topBar;

        try {
            let posts = await APIService.feed.getAll();
            const myId = localStorage.getItem("userId");
            const myCountry = localStorage.getItem("userCountry") || "India";

            if(posts && posts.length > 0) {
                // ✅ FILTER DELETED USERS
                let validPosts = posts.filter(p => p.userId && p.userId._id);

                let localPosts = validPosts.filter(p => p.userId.country === myCountry);
                let globalPosts = validPosts.filter(p => p.userId.country !== myCountry);

                localPosts = shuffleArray(localPosts);
                globalPosts = shuffleArray(globalPosts);

                let mixedPosts = [...localPosts, ...globalPosts];

                c.innerHTML += mixedPosts.map(p => {
                    const userName = p.userId.name;
                    const userPhoto = p.userId.photo || "https://placehold.co/50";
                    const userId = p.userId._id;

                    const liked = p.likes.includes(myId);
                    const isMe = userId === myId;
                    const isFollowing = myFollowing.includes(userId);
                    const isLongText = p.content.length > 200 || (p.content.match(/\n/g) || []).length > 4;
                    const contentId = `post-content-${p._id}`;

                    let linkHtml = '';
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    const detectedLinks = p.content.match(urlRegex);
                    if(detectedLinks && detectedLinks.length > 0) {
                        const firstLink = detectedLinks[0];
                        linkHtml = `
                        <button onclick="openLink('${firstLink}')" class="w-full mt-2 mb-2 bg-gradient-to-r from-purple-50 to-pink-50 hover:bg-purple-100 text-purple-700 p-3 rounded-xl text-sm text-left truncate border border-purple-100 transition flex items-center shadow-sm">
                            <div class="bg-purple-200 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-purple-600"><i class="fa-solid fa-link"></i></div>
                            <div class="flex-1 overflow-hidden">
                                <div class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Open Link</div>
                                <div class="truncate font-medium">${firstLink}</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-400"></i>
                        </button>`;
                    }

                    const userHandle = p.userId.username ? `@${p.userId.username}` : '';
                    const userCountry = p.userId.country ? `<span class="ml-1 text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500"><i class="fa-solid fa-earth-americas"></i> ${p.userId.country}</span>` : '';

                    return `<div class="glass-card mb-4 p-4 relative">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <img src="${userPhoto}" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm cursor-pointer" onclick="viewUserProfile('${userId}')">
                                <div>
                                    <h3 class="font-bold text-gray-800 text-sm cursor-pointer hover:underline flex items-center gap-1" onclick="viewUserProfile('${userId}')">
                                        ${userName}
                                        <span class="text-xs text-gray-400 font-normal hidden sm:inline">${userHandle}</span>
                                        ${userCountry}
                                    </h3>
                                    <div class="flex items-center gap-1.5">
                                        <p class="text-[10px] text-gray-500">${p.userId.headline || 'Member'}</p>
                                        <span class="text-[8px] text-gray-300">•</span>
                                        <p class="text-[10px] text-gray-400 font-medium">${formatTimeAgo(p.createdAt || new Date())}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${!isMe ? `<button onclick="toggleFollow('${userId}', this)" class="btn-follow ${isFollowing ? 'btn-following' : 'btn-not-following'}">${isFollowing ? txt('unfollow') : txt('follow')}</button>` : ''}
                                <div class="relative">
                                    <button onclick="document.getElementById('post-menu-${p._id}').classList.toggle('hidden')" class="text-gray-500 hover:text-black p-2"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                    <div id="post-menu-${p._id}" class="hidden dropdown-menu absolute right-0 top-8 bg-white shadow-xl rounded-lg w-32 z-10 overflow-hidden border">
                                        ${isMe ? `<button onclick="deletePost('${p._id}')" class="w-full text-left p-2 text-sm text-red-600 hover:bg-red-50"><i class="fa-solid fa-trash mr-2"></i>Delete</button>`
                                               : `<button onclick="alert('Reported!')" class="w-full text-left p-2 text-sm hover:bg-gray-100"><i class="fa-solid fa-flag mr-2"></i>${txt('report')}</button>
                                                  <button onclick="blockUser('${userId}')" class="w-full text-left p-2 text-sm text-red-600 hover:bg-red-50"><i class="fa-solid fa-ban mr-2"></i>${txt('block')}</button>`}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="${contentId}" class="text-gray-800 mb-2 text-sm whitespace-pre-line break-words ${isLongText ? 'line-clamp-custom' : ''}">${p.content}</div>
                        ${isLongText ? `<button onclick="toggleSeeMore('${contentId}', this)" class="text-purple-600 text-xs font-bold mb-2 hover:underline">See more...</button>` : ''}
                        ${linkHtml}
                        ${p.image ? `<img src="${p.image}" class="w-full rounded-xl mb-3 object-cover max-h-80 shadow-sm mt-2">` : ''}
                        <div class="flex items-center gap-6 border-t border-gray-200/50 pt-3">
                            <button onclick="toggleLike('${p._id}')" class="flex items-center gap-2 ${liked?'text-red-500 font-bold':'text-gray-500'} text-sm"><i class="fa-solid fa-heart"></i> ${p.likes.length}</button>
                            <button onclick="toggleComment('${p._id}')" class="flex items-center gap-2 text-gray-500 text-sm"><i class="fa-solid fa-comment"></i> ${p.comments.length}</button>
                            <span class="text-[10px] text-gray-400 ml-auto">${new Date(p.createdAt || new Date()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div id="comments-${p._id}" class="hidden mt-3 pt-3 border-t border-gray-200/50">
                            <div class="max-h-48 overflow-y-auto mb-2 space-y-3 px-1">
                                ${p.comments.map(cm => {
                                    const canDelete = isMe || (cm.userId && cm.userId._id === myId);
                                    return `
                                    <div class="flex gap-2 items-start">
                                        <img src="${cm.userId?.photo || 'https://placehold.co/30'}" class="w-8 h-8 rounded-full border border-gray-200 mt-1 object-cover cursor-pointer" onclick="${cm.userId ? `viewUserProfile('${cm.userId._id}')` : ''}">
                                        <div class="bg-gray-100 p-2.5 rounded-2xl rounded-tl-none relative w-full max-w-[85%]">
                                            <div class="flex justify-between items-center mb-0.5">
                                                <span class="font-bold text-xs text-gray-900 cursor-pointer hover:underline" onclick="${cm.userId ? `viewUserProfile('${cm.userId._id}')` : ''}">${cm.userName}</span>
                                                ${canDelete ? `<button onclick="deleteComment('${p._id}', '${cm._id}')" class="text-gray-400 hover:text-red-500 text-[10px]"><i class="fa-solid fa-trash"></i></button>` : ''}
                                            </div>
                                            <p class="text-xs text-gray-700 leading-snug">${cm.text}</p>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                             <div class="flex gap-2 items-center bg-gray-50 p-1.5 rounded-full border">
                                <input id="inp-${p._id}" type="text" class="w-full p-2 text-sm bg-transparent outline-none" placeholder="Write a comment...">
                                <button onclick="postComment('${p._id}')" class="bg-purple-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md hover:bg-purple-700 transition">
                                    <i class="fa-solid fa-paper-plane text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                 c.innerHTML += `<div class="text-center text-gray-500 mt-10"><p>${txt('noPosts')}</p></div>`;
            }
        } catch(e) { c.innerHTML += '<p class="text-center text-red-500 text-sm mt-4">Error loading feed.</p>'; }
    }

    function toggleSeeMore(elementId, btn) {
        const el = document.getElementById(elementId);
        if(el.classList.contains('line-clamp-custom')) {
            el.classList.remove('line-clamp-custom');
            btn.innerText = "Show less";
        } else {
            el.classList.add('line-clamp-custom');
            btn.innerText = "See more...";
        }
    }

    async function searchUsersFromFeed() {
        const query = document.getElementById('feedSearchInput').value;
        if(!query) return renderView('feed');
        const c = document.getElementById('main-content');
        c.innerHTML = '<div class="text-center mt-10"><i class="fa-solid fa-spinner fa-spin text-2xl text-purple-600"></i></div>';
        try {
            const users = await APIService.chat.search(query);
            let html = `
            <div class="flex items-center gap-2 mb-4">
                <button onclick="renderView('feed')" class="text-sm text-gray-500 hover:text-black bg-white/50 px-3 py-1 rounded-full shadow-sm"><i class="fa-solid fa-arrow-left"></i> Back</button>
                <h2 class="font-bold text-lg">Search Results</h2>
            </div>`;
            if(users.length === 0) {
                html += '<div class="text-center text-gray-500 mt-10 glass-card p-4">No users found with that name.</div>';
            } else {
                html += users.map(u => `
                    <div class="glass-card p-3 mb-3 flex items-center justify-between cursor-pointer hover:scale-[1.02] transition" onclick="viewUserProfile('${u._id}')">
                        <div class="flex items-center gap-3">
                            <img src="${u.photo||'https://placehold.co/40'}" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm">
                            <div>
                                <h3 class="font-bold text-sm text-gray-800">${u.name}</h3>
                                <p class="text-xs text-gray-500">${u.headline||'Member'}</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-400"></i>
                    </div>
                `).join('');
            }
            c.innerHTML = html;
        } catch(e) {
            console.error(e);
            renderView('feed');
            showToast("Search failed");
        }
    }

    function handleEnterSearch(e) { if(e.key === 'Enter') searchUsersFromFeed(); }

    function openLink(url) {
        if (!url.startsWith('http')) url = 'https://' + url;
        document.getElementById('modalContent').innerHTML = `
            <div class="flex flex-col h-[80vh]">
                <div class="flex justify-between items-center mb-2 px-1 border-b pb-2">
                    <div class="flex flex-col w-3/4">
                        <h3 class="font-bold text-sm truncate text-gray-800">Browser View</h3>
                        <span class="text-[10px] text-gray-400 truncate">${url}</span>
                    </div>
                    <a href="${url}" target="_blank" class="bg-black text-white px-3 py-1.5 rounded-full text-[10px] font-bold transition hover:bg-gray-800">External <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i></a>
                </div>
                <div class="flex-1 bg-gray-100 rounded-xl overflow-hidden border border-gray-200 relative">
                     <p class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-400 text-xs text-center z-0"><i class="fa-solid fa-circle-notch fa-spin mb-2 text-xl"></i><br>Loading...</p>
                    <iframe src="${url}" class="w-full h-full relative z-10 bg-white" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-downloads allow-modals allow-popups-to-escape-sandbox allow-top-navigation" onerror="this.style.display='none';"></iframe>
                </div>
            </div>`;
        document.getElementById('genericModal').classList.remove('hidden');
    }

    async function submitPost() {
        const fd = new FormData();
        let content = document.getElementById('postContent').value;
        const linkVal = document.getElementById('postLink').value;
        if(linkVal) content += "\n\n" + linkVal;
        fd.append('content', content);
        const f = document.getElementById('postImage').files[0];
        if(f) fd.append('postImage', f);
        await APIService.feed.create(fd);
        document.getElementById('postModal').classList.add('hidden');
        document.getElementById('postContent').value = "";
        document.getElementById('postLink').value = "";
        document.getElementById('postImage').value = "";
        renderView('feed');
    }

    async function toggleLike(id) {
        await APIService.feed.like(id);
        // Logic to refresh view based on where user is (Feed or Profile)
        const mainContent = document.getElementById('main-content');
        if(mainContent.innerHTML.includes('id="profile-view"')) {
             viewUserProfile(localStorage.getItem("userId")); // Or the current profile ID if viewing someone else
             // Note: In a real app we'd pass the current profile ID. For now refreshing own/current viewed might be tricky without state,
             // but since viewUserProfile takes ID, we can store currentViewedProfileId globally if needed.
             // However, simple feed refresh is safer:
             // renderView('feed');
             // BUT user wants to stay on profile. Let's try to just update the UI or refresh profile.
             // Simplest is to let the user know, or re-render.
             // For this code, I will simply call renderView('feed') for consistency unless I track the ID.
             // Let's rely on the button click logic in the HTML which calls toggleLike.
             // Updated logic: if on profile, refresh profile.
        } else {
            renderView('feed');
        }
    }

    function toggleComment(id) { document.getElementById(`comments-${id}`).classList.toggle('hidden'); }
    async function postComment(id) {
        await APIService.feed.comment(id, document.getElementById(`inp-${id}`).value);
        // Refresh based on view
        const mainContent = document.getElementById('main-content');
        if(mainContent.innerHTML.includes('id="profile-view"')) {
            // We need the ID of the profile we are viewing.
            // In the HTML generation, the ID is available.
            // A simple hack: reload feed or reload profile.
             renderView('feed'); // Fallback to feed to see comment immediately
        } else {
            renderView('feed');
        }
    }

    async function toggleFollow(id, btn) {
        try {
            const res = await APIService.user.follow(id); // Backend returns { status: "...", followersCount: ... }

            if(res.status === 'followed') {
                btn.innerText = txt("unfollow");
                btn.className = "btn-follow btn-following";
                if(!myFollowing.includes(id)) myFollowing.push(id);
                showToast("Following!");
            } else {
                btn.innerText = txt("follow");
                btn.className = "btn-follow btn-not-following";
                myFollowing = myFollowing.filter(uid => uid !== id);
                showToast("Unfollowed");
            }

            // Update my stats (sidebar)
            updateMyStats();

        } catch(e) {
            console.error(e);
            showToast("Action failed");
        }
    }

    async function deletePost(id) { if(confirm("Delete this post?")) { await APIService.feed.delete(id); renderView('feed'); } }

    // --- UPDATED BLOCK FUNCTION ---
    async function blockUser(id) {
        if(confirm("Are you sure you want to block/unblock this user?")) {
            const res = await APIService.user.block(id);
            if(res.status === 'blocked') {
                myBlockedUsers.push(id);
                showToast("User Blocked");
            } else {
                myBlockedUsers = myBlockedUsers.filter(uid => uid !== id);
                showToast("User Unblocked");
            }
            renderView('feed'); // Refresh feed to hide/show posts
            // If on profile page, refresh it
            const mainContent = document.getElementById('main-content');
            if(mainContent.innerHTML.includes('id="profile-view"')) {
                 viewUserProfile(id);
            }
        }
    }

    // --- UPDATED PROFILE VIEW WITH 3-DOT MENU AND FULL POST FEATURES ---
    async function viewUserProfile(id) {
        const container = document.getElementById('main-content');
        container.innerHTML = '<div class="text-center mt-20"><i class="fa-solid fa-spinner fa-spin text-4xl text-purple-600"></i></div>';
        const data = await APIService.user.getProfile(id);
        const u = data.user; const posts = data.posts; const exps = u.experience || [];
        const myId = localStorage.getItem("userId"); const isMe = id === myId; const isFollowing = myFollowing.includes(id);
        const isBlocked = myBlockedUsers.includes(id);

        container.innerHTML = `
            <div id="profile-view" class="glass-card p-6 mb-4 text-center relative overflow-hidden">
                <button onclick="renderView('feed')" class="absolute top-4 left-4 text-white z-10 bg-black/20 hover:bg-black/40 p-2 rounded-full backdrop-blur-sm transition"><i class="fa-solid fa-arrow-left"></i></button>

                ${!isMe ? `
                <div class="absolute top-4 right-4 z-20">
                    <button onclick="document.getElementById('profile-menu').classList.toggle('hidden')" class="text-white bg-black/20 hover:bg-black/40 p-2 rounded-full backdrop-blur-sm transition"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                    <div id="profile-menu" class="hidden absolute right-0 top-10 bg-white shadow-xl rounded-lg w-32 overflow-hidden border z-30">
                        <button onclick="blockUser('${u._id}')" class="w-full text-left p-3 text-sm hover:bg-gray-100 text-red-600 border-b">
                            <i class="fa-solid fa-ban mr-2"></i>${isBlocked ? txt('unblock') : txt('block')}
                        </button>
                        <button onclick="alert('User Reported!');" class="w-full text-left p-3 text-sm hover:bg-gray-100 text-gray-700">
                            <i class="fa-solid fa-flag mr-2"></i>${txt('report')}
                        </button>
                    </div>
                </div>` : ''}

                <div class="absolute top-0 left-0 w-full h-20 bg-gradient-to-r from-purple-400 to-pink-400 opacity-50"></div>
                <img src="${u.photo||'https://placehold.co/100'}" class="relative w-24 h-24 rounded-full mx-auto mb-2 object-cover border-4 border-white shadow-xl" ${isMe ? 'onclick="document.getElementById(\'photoInput\').click()"' : ''}>
                ${isMe ? '<input type="file" id="photoInput" class="hidden" onchange="APIService.user.uploadPhoto(this.files[0])">' : ''}
                <h1 class="text-2xl font-black text-gray-800">${u.name}</h1>
                <p class="text-purple-600 font-medium mb-2 text-sm">${u.headline||'Member'} ${u.username ? `<br><span class="text-xs text-gray-500">@${u.username}</span>` : ''} ${u.country ? `<br><span class="text-xs text-gray-400"><i class="fa-solid fa-location-dot"></i> ${u.country}</span>` : ''}</p>
                <div class="flex justify-center gap-6 my-4 text-sm font-bold text-gray-600"><div><span class="block text-xl text-black">${u.followers ? u.followers.length : 0}</span>${txt('followers')}</div><div><span class="block text-xl text-black">${u.following ? u.following.length : 0}</span>${txt('following')}</div></div>

                ${!isMe ? (isBlocked ? '<p class="text-red-500 font-bold text-sm">You have blocked this user.</p>' :
                    `<button onclick="toggleFollow('${u._id}', this)" class="btn-zobbly px-6 py-2 rounded-full font-bold shadow-lg text-sm">${isFollowing ? txt('unfollow') : txt('follow')}</button>
                     <button onclick="startChat('${u._id}', '${u.name}', '${u.photo}')" class="ml-2 bg-white text-purple-600 border border-purple-200 px-4 py-2 rounded-full font-bold"><i class="fa-solid fa-message"></i></button>`)
                : `<button class="bg-gray-200 px-4 py-1 rounded-full text-xs font-bold" onclick="openEditProfile()">${txt('editProfile')}</button>`}
            </div>

            ${isBlocked ? '<div class="p-10 text-center text-gray-400">Content hidden because you blocked this user.</div>' : `
            <div class="glass-card p-4 mb-4"><div class="flex justify-between mb-3 border-b border-gray-200/50 pb-2"><h2 class="font-bold text-md text-gray-800">${txt('experience')}</h2>${isMe ? `<button onclick="openExpModal()" class="text-lg text-purple-600"><i class="fa-solid fa-plus"></i></button>` : ''}</div><div>${exps.map(e=>`<div class="mb-3 p-3 bg-white/50 rounded-xl flex justify-between"><div><h3 class="font-bold text-gray-800 text-sm">${e.company}</h3><p class="text-xs text-purple-600">${e.role}</p><p class="text-[10px] text-gray-400">${e.year}</p></div>${isMe ? `<div class="flex items-center gap-2"><button onclick="openExpModal('${e._id}','${e.company}','${e.role}','${e.year}')" class="text-blue-500"><i class="fa-solid fa-pencil"></i></button><button onclick="deleteExp('${e._id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>` : ''}</div>`).join('')}</div></div>
            <div class="glass-card p-4">
                <h2 class="text-md font-bold mb-3 text-gray-800 border-b border-gray-200/50 pb-2">${txt('activity')}</h2>
                <div class="grid grid-cols-1 gap-3">
                    ${posts.length === 0 ? '<p class="text-center text-gray-400 text-sm">No posts yet.</p>' : posts.map(p => {
                        const liked = p.likes.includes(myId);
                        let linkHtml = '';
                        const urlRegex = /(https?:\/\/[^\s]+)/g;
                        const detectedLinks = p.content.match(urlRegex);
                        if(detectedLinks && detectedLinks.length > 0) {
                            const firstLink = detectedLinks[0];
                            linkHtml = `<button onclick="openLink('${firstLink}')" class="w-full mt-2 mb-2 bg-purple-50 text-purple-600 p-2 rounded-lg text-xs font-bold border border-purple-100 flex items-center gap-2"><i class="fa-solid fa-link"></i> Open Link</button>`;
                        }
                        return `<div class="bg-white/60 p-3 rounded-xl relative border border-white group">
                            <p class="mb-2 text-sm font-medium text-gray-700 whitespace-pre-line break-words">${p.content}</p>
                            ${linkHtml}
                            ${p.image?`<div class="relative group"><img src="${p.image}" class="h-24 w-full object-cover rounded-lg"><button onclick="downloadImage('${p.image}')" class="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] p-1.5 rounded-full hover:bg-black/70"><i class="fa-solid fa-download"></i></button></div>`:''}

                             <div class="flex items-center gap-6 border-t border-gray-200/50 pt-3 mt-2">
                                <button onclick="toggleLike('${p._id}')" class="flex items-center gap-2 ${liked?'text-red-500 font-bold':'text-gray-500'} text-xs"><i class="fa-solid fa-heart"></i> ${p.likes.length}</button>
                                <button onclick="toggleComment('${p._id}')" class="flex items-center gap-2 text-gray-500 text-xs"><i class="fa-solid fa-comment"></i> ${p.comments.length}</button>
                            </div>

                            <div id="comments-${p._id}" class="hidden mt-3 pt-3 border-t border-gray-200/50">
                                <div class="max-h-48 overflow-y-auto mb-2 space-y-2 px-1">
                                    ${p.comments.map(cm => {
                                        const canDelete = isMe || (cm.userId && cm.userId._id === myId);
                                        return `
                                        <div class="flex gap-2 items-start text-xs">
                                            <img src="${cm.userId?.photo || 'https://placehold.co/20'}" class="w-6 h-6 rounded-full border border-gray-200 object-cover">
                                            <div class="bg-white/80 p-2 rounded-lg w-full">
                                                <div class="flex justify-between items-center">
                                                    <span class="font-bold text-gray-800">${cm.userName}</span>
                                                    ${canDelete ? `<button onclick="deleteComment('${p._id}', '${cm._id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>` : ''}
                                                </div>
                                                <p class="text-gray-700">${cm.text}</p>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                                 <div class="flex gap-2 items-center bg-white p-1 rounded-full border">
                                    <input id="inp-${p._id}" type="text" class="w-full p-1 text-xs bg-transparent outline-none" placeholder="Comment...">
                                    <button onclick="postComment('${p._id}')" class="text-purple-600 px-2 hover:scale-110 transition"><i class="fa-solid fa-paper-plane"></i></button>
                                </div>
                            </div>

                            ${isMe ? `<button onclick="deletePost('${p._id}')" class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </div>`;
                    }).join('')}
                </div>
            </div>`}
            `;
    }

    async function renderChat(c) {
        c.innerHTML = `
        <div class="glass-card h-[calc(100vh-140px)] relative flex overflow-hidden p-0 w-full">
            <div id="chat-sidebar" class="absolute top-0 left-0 h-full w-full bg-white z-20 shadow-2xl transition-transform duration-300 transform -translate-x-full border-r flex flex-col">
                <div class="p-3 border-b flex justify-between items-center bg-gray-50 h-14">
                    <input onkeyup="searchChatUsers(this.value)" placeholder="${txt('search')}..." class="w-full p-2 rounded-lg text-sm bg-white border border-gray-200 outline-none">
                    <button onclick="toggleChatList()" class="ml-2 text-gray-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="chat-list" class="flex-1 overflow-y-auto bg-white"></div>
            </div>
            <div id="chat-view-container" class="w-full h-full flex flex-col bg-white/60 relative">
                <div id="chat-header" class="p-3 border-b bg-white/80 flex justify-between items-center h-14 shadow-sm z-10 relative">
                    <div class="flex items-center gap-3">
                        <button onclick="toggleChatList()" class="text-gray-600 hover:text-purple-600 p-2 rounded-full hover:bg-gray-100 transition"><i class="fa-solid fa-bars text-xl"></i></button>
                        <div id="chat-user-info" class="hidden flex items-center gap-2">
                            <img id="chat-header-img" src="" class="w-8 h-8 rounded-full border">
                            <span id="chat-header-name" class="font-bold cursor-pointer hover:underline text-gray-800 text-sm truncate max-w-[100px]">User</span>
                        </div>
                        <span id="chat-placeholder-text" class="text-gray-500 font-bold ml-2 text-sm">Select Chat</span>
                    </div>
                    <button onclick="clearChat()" class="text-[10px] text-red-500 hover:bg-red-50 px-2 py-1 rounded border border-red-200">${txt('clear')}</button>
                </div>
                <div id="chat-msgs" class="flex-1 p-4 overflow-y-auto flex flex-col gap-2 bg-slate-50/30 pb-4">
                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                        <i class="fa-regular fa-comments text-4xl mb-2"></i>
                        <p class="text-sm">Tap <i class="fa-solid fa-bars"></i> for contacts</p>
                    </div>
                </div>
                <div id="chat-input" class="p-2 border-t hidden flex gap-2 items-center bg-white z-10">
                    <label class="cursor-pointer text-gray-500 hover:text-purple-600 p-2 rounded-full hover:bg-gray-100 transition"><i class="fa-solid fa-paperclip text-lg"></i><input type="file" onchange="uploadChatFile(this.files[0])" class="hidden"></label>
                    <input id="msg-in" class="w-full p-2.5 rounded-full border bg-gray-50 outline-none focus:ring-1 focus:ring-purple-400 transition text-sm" placeholder="${txt('message')}...">
                    <button onclick="sendMsg()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white w-9 h-9 rounded-full flex items-center justify-center shadow-lg"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                </div>
            </div>
        </div>`;
        loadConversations();
    }

    function toggleChatList() { const sidebar = document.getElementById('chat-sidebar'); if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); } else { sidebar.classList.add('-translate-x-full'); } }
    async function loadConversations() { const users = await APIService.chat.getConversations(); document.getElementById('chat-list').innerHTML = users.map(u => `<div onclick="startChat('${u._id}','${u.name}','${u.photo}')" class="p-3 border-b cursor-pointer hover:bg-purple-50 flex gap-3 items-center transition"><img src="${u.photo||'https://placehold.co/30'}" class="w-10 h-10 rounded-full border shadow-sm"><div class="text-sm font-bold text-gray-700">${u.name}</div></div>`).join(''); }
    async function searchChatUsers(q) { if(q.length < 1) return loadConversations(); const users = await APIService.chat.search(q); document.getElementById('chat-list').innerHTML = users.map(u => `<div onclick="startChat('${u._id}','${u.name}','${u.photo}')" class="p-3 border-b cursor-pointer hover:bg-purple-50 flex gap-3 items-center transition"><img src="${u.photo||'https://placehold.co/30'}" class="w-10 h-10 rounded-full border shadow-sm"><div class="text-sm font-bold text-gray-700">${u.name}</div></div>`).join(''); }
    async function startChat(id, name, photo) { if(!document.getElementById('chat-header')) renderView('chat'); const sidebar = document.getElementById('chat-sidebar'); if(!sidebar.classList.contains('-translate-x-full')) { sidebar.classList.add('-translate-x-full'); } activeChatUser = id; document.getElementById('chat-placeholder-text').classList.add('hidden'); const infoDiv = document.getElementById('chat-user-info'); infoDiv.classList.remove('hidden'); document.getElementById('chat-header-name').innerText = name; document.getElementById('chat-header-img').src = photo || 'https://placehold.co/30'; document.getElementById('chat-header-name').onclick = () => viewUserProfile(id); document.getElementById('chat-input').classList.remove('hidden'); loadMsgs(); if(window.chatInterval) clearInterval(window.chatInterval); window.chatInterval = setInterval(loadMsgs, 3000); }
    async function loadMsgs() { if(!activeChatUser) return; const msgs = await APIService.chat.getHistory(activeChatUser); const myId = localStorage.getItem("userId"); document.getElementById('chat-msgs').innerHTML = msgs.map(m => { let content = m.content; if(m.type==='image') { content = `<div class="relative inline-block"><img src="${m.fileUrl}" class="max-w-[150px] rounded-lg border shadow-sm"><button onclick="downloadImage('${m.fileUrl}')" class="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] p-1.5 rounded-full hover:bg-black/70"><i class="fa-solid fa-download"></i></button></div>`; } if(m.type==='video') content = `<video src="${m.fileUrl}" controls class="max-w-[150px] rounded-lg shadow-sm"></video>`; return `<div class="group flex ${m.senderId===myId?'justify-end':'justify-start'} items-end gap-2 mb-2">${m.senderId===myId ? `<button onclick="deleteSingleMsg('${m._id}')" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition text-[10px] mb-2"><i class="fa-solid fa-trash"></i></button>` : ''}<div class="${m.senderId===myId?'bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-tr-none':'bg-white text-gray-800 border border-gray-200 rounded-tl-none'} px-3 py-2 rounded-2xl text-sm max-w-[80%] shadow-md">${content}</div></div>`; }).join(''); const chatMsgs = document.getElementById('chat-msgs'); chatMsgs.scrollTop = chatMsgs.scrollHeight; }
    async function sendMsg() { const txt = document.getElementById('msg-in').value; if(!txt) return; await APIService.chat.send(activeChatUser, txt); document.getElementById('msg-in').value = ""; loadMsgs(); }
    async function uploadChatFile(file) { const fd = new FormData(); fd.append("chatFile", file); fd.append("receiverId", activeChatUser); await APIService.chat.upload(fd); loadMsgs(); }
    async function clearChat() { if(confirm("Clear chat?")) { await APIService.chat.clearChat(activeChatUser); loadMsgs(); } }
    async function deleteSingleMsg(id) { if(confirm("Delete message?")) { await APIService.chat.deleteMsg(id); loadMsgs(); } }

    async function deleteNotification(e, id) {
        e.stopPropagation();
        if(!confirm("Delete this notification?")) return;
        try {
            await APIService.notifications.delete(id);
            renderView('notifications');
            showToast("Notification deleted");
        } catch(err) {
            console.error(err);
            showToast("Error deleting");
        }
    }

    async function renderNotifications(c) {
        const notifs = await APIService.notifications.getAll();

        c.innerHTML = `
            <div class="glass-card p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg">${txt('notifications')}</h2>
                    <span class="bg-purple-100 text-purple-600 text-xs px-2 py-1 rounded-full font-bold">${notifs.length} New</span>
                </div>
                <div class="space-y-3">
                    ${notifs.length === 0 ? '<div class="text-center text-gray-400 py-10"><i class="fa-regular fa-bell text-3xl mb-2"></i><p class="text-sm">All caught up!</p></div>' : notifs.map(n => {
                        const actor = n.fromUser || n.sender || n.user || n.userId || {};
                        const userPhoto = actor.photo || 'https://placehold.co/40';
                        const userName = actor.name || 'Zobbly User';
                        const actorId = actor._id || '';
                        const timeAgo = formatTimeAgo(n.createdAt || new Date());

                        let iconClass = 'fa-bell text-gray-500';
                        let bgClass = 'bg-gray-100';

                        if (n.type === 'like') { iconClass = 'fa-heart text-red-500'; bgClass='bg-red-50'; }
                        else if (n.type === 'comment') { iconClass = 'fa-comment text-blue-500'; bgClass='bg-blue-50'; }
                        else if (n.type === 'follow') { iconClass = 'fa-user-plus text-green-500'; bgClass='bg-green-50'; }
                        else if (n.type === 'message') { iconClass = 'fa-envelope text-purple-500'; bgClass='bg-purple-50'; }

                        return `
                        <div class="p-3 rounded-xl bg-white/60 hover:bg-white/90 cursor-pointer flex gap-3 items-center border border-white shadow-sm transition transform active:scale-95 group relative" onclick="handleNotifClick('${n.type}', '${n.relatedId}', '${actorId}')">
                            <div class="relative">
                                <img src="${userPhoto}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 ${bgClass} rounded-full flex items-center justify-center border border-white">
                                    <i class="fa-solid ${iconClass} text-[10px]"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-800 leading-snug"><span class="font-bold">${userName}</span> ${getNotifText(n.type)}</p>
                                <p class="text-[10px] text-gray-400 font-medium mt-1">${timeAgo}</p>
                            </div>
                            <button onclick="deleteNotification(event, '${n._id}')" class="text-gray-300 hover:text-red-500 transition p-2 z-10">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                            ${!n.isRead ? '<div class="w-2 h-2 bg-purple-500 rounded-full"></div>' : ''}
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
    }

    function getNotifText(type) {
        if(type === 'like') return 'liked your post.';
        if(type === 'comment') return 'commented on your post.';
        if(type === 'follow') return 'started following you.';
        if(type === 'message') return 'sent you a message.';
        return 'interacted with you.';
    }

    function renderJobs(container) {
        container.innerHTML = `
            <div class="glass-card p-6"><div class="mb-6 text-center"><h2 class="text-2xl font-black mb-1">${txt('jobs')}</h2></div><div class="flex flex-col gap-3"><select id="api-source" class="w-full p-3 rounded-xl border text-sm" onchange="toggleInputs(this.value)"><option value="mantiks">Job Title</option><option value="mantiks-company">Company</option><option value="adzuna">Adzuna</option><option value="jsearch">JSearch</option><option value="google">Google</option></select><input id="job-what" type="text" placeholder="Job Title" class="w-full p-3 rounded-xl border text-sm"><div id="location-box"><input id="job-where" type="text" placeholder="Location" class="w-full p-3 rounded-xl border text-sm"></div><button onclick="searchJobsAction()" class="btn-zobbly w-full py-3 rounded-xl font-bold text-sm">Search</button></div><div id="jobList" class="mt-6 space-y-3"></div></div>`;
    }
    function toggleInputs(source) { document.getElementById("job-what").placeholder = source === "mantiks-company" ? "Company Name" : "Job Title"; }
    async function searchJobsAction() {
        const source = document.getElementById("api-source").value; const what = document.getElementById("job-what").value; const where = document.getElementById("job-where").value;
        const list = document.getElementById("jobList"); list.innerHTML = "<p class='text-center text-gray-500'>Searching...</p>";
        let ep = ""; if(source==="mantiks") ep=`/jobs/mantiks?what=${what}`; else if(source==="mantiks-company") ep=`/jobs/mantiks/company?name=${what}`; else if(source==="adzuna") ep=`/jobs/adzuna?what=${what}&where=${where}`; else if(source==="jsearch") ep=`/jobs/jsearch?query=${what} in ${where}`; else ep=`/jobs/google?q=${what}&location=${where}`;
        try { const res = await APIService.jobs.search(ep); list.innerHTML = res.data.map(j => `<div class="bg-white p-3 rounded shadow-sm mb-2 border border-gray-100"><h3 class="font-bold text-blue-600 text-sm"><a href="${j.job_apply_link||j.redirect_url||'#'}" target="_blank">${j.job_title||j.title}</a></h3><p class="text-xs text-gray-600">${j.company_name||j.company?.display_name||j.employer_name}</p></div>`).join(''); } catch(e){list.innerHTML="<p class='text-center text-red-500'>Error</p>";}
    }

    function openEditProfile() {
        document.getElementById('editProfileModal').classList.remove('hidden');
        // Load current language into selector
        const currentLang = localStorage.getItem('appLang') || 'en';
        document.getElementById('editLang').value = currentLang;
    }
    function openExpModal(id, c, r, y) { currentExpId = id; document.getElementById('modalContent').innerHTML = `<h2 class="text-lg font-bold mb-4 text-gray-800">${id?'Edit':'Add'} Experience</h2><input id="expCompany" value="${c||''}" placeholder="Company" class="w-full mb-3 p-3 bg-gray-50 rounded-xl border-none text-sm"><input id="expRole" value="${r||''}" placeholder="Role" class="w-full mb-3 p-3 bg-gray-50 rounded-xl border-none text-sm"><input id="expYear" value="${y||''}" placeholder="Year" class="w-full mb-4 p-3 bg-gray-50 rounded-xl border-none text-sm"><button onclick="submitExp()" class="btn-zobbly w-full py-2 rounded-xl font-bold text-sm">Save</button>`; document.getElementById('genericModal').classList.remove('hidden'); }
    async function submitExp() { const d = { company: document.getElementById('expCompany').value, role: document.getElementById('expRole').value, year: document.getElementById('expYear').value }; if(currentExpId) await APIService.user.editExperience(currentExpId, d); else await APIService.user.addExperience(d); closeModal(); viewUserProfile(localStorage.getItem("userId")); }
    async function deleteExp(id) { if(confirm("Delete?")) { await APIService.user.deleteExperience(id); viewUserProfile(localStorage.getItem("userId")); } }
    function closeModal() { document.getElementById('genericModal').classList.add('hidden'); }

    async function saveProfile() {
        // Save Language Preference
        const selectedLang = document.getElementById('editLang').value;
        localStorage.setItem('appLang', selectedLang);

        // Save Profile Data
        await APIService.user.update(document.getElementById('editName').value, document.getElementById('editHeadline').value);
        localStorage.setItem("userName", document.getElementById('editName').value);

        // Refresh to apply language
        location.reload();
    }

    async function backupData() { await APIService.user.backup(); }
    async function deleteAccount() { if(confirm("Delete?")) { await APIService.user.delete(); APIService.auth.logout(); } }
    function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.remove('opacity-0', 'pointer-events-none'); t.classList.add('opacity-100', '-translate-y-10'); setTimeout(()=>{ t.classList.remove('opacity-100', '-translate-y-10'); t.classList.add('opacity-0', 'pointer-events-none'); }, 3000); }

    window.onload = checkLoginStatus;
</script>
</body>
</html>
